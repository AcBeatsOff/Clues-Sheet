<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLUEDO V6 LOGIQUE</title>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #ffffff;
            --grid-line: #333;
            --yes-col: #004d40;
            --no-col: #3e2723;
            --maybe-col: #1a3c5e;
            --input-bg: #2c2c2c;
            --solution-bg: #00e676;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }

        nav { display: flex; background: var(--surface); z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        nav button { flex: 1; padding: 15px; background: none; border: none; color: #888; font-weight: bold; font-size: 0.9rem; border-bottom: 3px solid transparent; }
        nav button.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); }

        .page { flex: 1; display: none; overflow-y: auto; padding-bottom: 50px; }
        .page.active { display: block; }

        .table-container { overflow-x: auto; width: 100%; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid var(--grid-line); padding: 8px 4px; text-align: center; font-size: 0.8rem; white-space: nowrap; height: 40px; min-width: 40px; }
        
        td:first-child, th:first-child { position: sticky; left: 0; background: var(--surface); z-index: 10; width: 120px; text-align: left; padding-left: 8px; border-right: 2px solid var(--grid-line); font-weight: bold; overflow: hidden; text-overflow: ellipsis; }
        thead th { position: sticky; top: 0; background: var(--surface); z-index: 20; }
        
        td.state-no { background-color: var(--no-col); color: #777; }
        td.state-yes { background-color: var(--yes-col); color: #80cbc4; font-weight: bold; font-size:1.1rem; }
        td.state-maybe { background-color: var(--maybe-col); color: #64b5f6; font-weight: bold; }
        .eliminated-row { opacity: 0.3; }

        /* FIXE VERT FLUO */
        tr.solution-found td:first-child { background-color: var(--solution-bg) !important; color: black !important; font-weight: 900 !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); z-index: 15 !important; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        h3 { color: var(--secondary); border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 25px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--input-bg); border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-family: monospace; font-size: 1rem; }
        button.action-btn { width: 100%; padding: 15px; background: var(--secondary); color: black; border: none; border-radius: 4px; font-weight: bold; font-size: 1rem; margin-top: 10px; }
        button.danger-btn { background: #cf6679; color: white; margin-top: 30px; }

        .clue-card { background: var(--surface); padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #555; position: relative; }
        .clue-card.solved { border-left-color: var(--secondary); background: #00251a; }
        .clue-items { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .clue-tag { background: #333; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .clue-tag.eliminated { text-decoration: line-through; opacity: 0.5; }
        .clue-tag.found { background: var(--secondary); color: black; font-weight: bold; }
        .clue-tag.maybe-yes { border: 1px solid var(--secondary); color: var(--secondary); } /* Juste pour info visuelle */
        .del-clue { position: absolute; top: 5px; right: 10px; background: none; border: none; color: #666; font-size: 1.5rem; padding: 0 10px; }
    </style>
</head>
<body>

<nav>
    <button id="btn-grid" class="active" onclick="switchTab('grid')">GRILLE</button>
    <button id="btn-sherlock" onclick="switchTab('sherlock')">JOURNAL</button>
    <button id="btn-config" onclick="switchTab('config')">CONFIG</button>
</nav>

<div id="page-grid" class="page active">
    <div class="table-container">
        <table id="mainTable">
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <div style="text-align: center; padding: 20px; color: #555; font-size: 0.8rem;">
        Cycle : VIDE -> <span style="color:#777; font-weight:bold;">-</span> -> <span style="color:var(--secondary); font-weight:bold;">X</span> -> <span style="color:#64b5f6; font-weight:bold;">?</span>
    </div>
</div>

<div id="page-sherlock" class="page">
    <div class="container">
        <div style="background: var(--surface); padding:15px; border-radius:8px;">
            <label>Qui montre une carte ?</label>
            <select id="s-player"></select>
            <label>Cartes demandées :</label>
            <select id="s-suspect"></select>
            <select id="s-weapon"></select>
            <select id="s-place"></select>
            <button class="action-btn" onclick="addClue()">AJOUTER INDICE</button>
        </div>
        <div id="clueList" style="margin-top:20px;"></div>
    </div>
</div>

<div id="page-config" class="page">
    <div class="container">
        <h3>Configuration</h3>
        <label>Nombre d'adversaires</label>
        <select id="cfg-player-count" onchange="renderPlayerInputs()">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5" selected>5</option><option value="6">6</option>
        </select>
        <div id="cfg-player-names"></div>
        <h3>Cartes</h3>
        <label>Suspects</label><textarea id="cfg-suspects"></textarea>
        <label>Armes</label><textarea id="cfg-weapons"></textarea>
        <label>Pièces</label><textarea id="cfg-places"></textarea>
        <button class="action-btn" onclick="saveConfig()">SAUVEGARDER</button>
        <button class="action-btn danger-btn" onclick="fullReset()">RESET</button>
    </div>
</div>

<script>
    const DEFAULT_CONFIG = {
        playerCount: 5, 
        playerNames: ["J2", "J3", "J4", "J5", "J6"], 
        suspects: ["Col. Mustard", "Pr. Plum", "M. Green", "Mme Peacock", "Mlle Scarlett", "Mme White"],
        weapons: ["Couteau", "Chandelier", "Revolver", "Corde", "Tuyau de plomb", "Clé anglaise"],
        places: ["Hall", "Salon", "Salle à manger", "Cuisine", "Salle de bal", "Serre", "Salle de billard", "Bibliothèque", "Bureau"]
    };

    let appConfig = {};
    let gridData = {}; 
    let clues = [];

    function init() {
        loadData();
        renderConfigInputs();
        renderTable();
        updateSherlockUI();
        updateMath();
    }

    // --- CONFIG ---
    function renderConfigInputs() {
        document.getElementById("cfg-player-count").value = appConfig.playerCount;
        document.getElementById("cfg-suspects").value = appConfig.suspects.join("\n");
        document.getElementById("cfg-weapons").value = appConfig.weapons.join("\n");
        document.getElementById("cfg-places").value = appConfig.places.join("\n");
        renderPlayerInputs();
    }
    function renderPlayerInputs() {
        const count = parseInt(document.getElementById("cfg-player-count").value);
        const container = document.getElementById("cfg-player-names");
        container.innerHTML = "<label>Adversaires :</label>";
        for (let i = 0; i < count; i++) {
            let input = document.createElement("input");
            input.type = "text"; input.id = `cfg-pname-${i}`; input.placeholder = `J${i+2}`;
            input.value = appConfig.playerNames[i] || `J${i+2}`;
            container.appendChild(input);
        }
    }
    function saveConfig() {
        const count = parseInt(document.getElementById("cfg-player-count").value);
        let newNames = [];
        for (let i = 0; i < count; i++) { newNames.push(document.getElementById(`cfg-pname-${i}`).value.trim() || `J${i+2}`); }
        const parseList = (id) => document.getElementById(id).value.split("\n").map(s => s.trim()).filter(s => s !== "");
        appConfig.playerCount = count; appConfig.playerNames = newNames;
        appConfig.suspects = parseList("cfg-suspects"); appConfig.weapons = parseList("cfg-weapons"); appConfig.places = parseList("cfg-places");
        localStorage.setItem("cluedo_config_v6", JSON.stringify(appConfig));
        alert("Sauvegardé !"); renderTable(); updateSherlockUI(); switchTab('grid');
    }

    // --- GRID ---
    function renderTable() {
        const thead = document.getElementById("headerRow"); thead.innerHTML = "<th>Carte</th>";
        let allPlayers = ["MOI", ...appConfig.playerNames];
        allPlayers.forEach(p => { let th = document.createElement("th"); th.innerText = p; thead.appendChild(th); });

        const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
        const buildSection = (title, items, typePrefix) => {
            let trH = document.createElement("tr"); trH.innerHTML = `<td colspan="${allPlayers.length + 1}" class="cat-header">${title}</td>`; tbody.appendChild(trH);
            items.forEach((item, index) => {
                let tr = document.createElement("tr"); tr.id = `row-${typePrefix}-${index}`;
                let tdName = document.createElement("td"); tdName.innerText = item; tr.appendChild(tdName);
                allPlayers.forEach((p, pIndex) => {
                    let td = document.createElement("td"); let key = `p${pIndex}_${typePrefix}${index}`;
                    td.onclick = () => toggleCell(key, pIndex, typePrefix, index);
                    let state = gridData[key] || 0;
                    if(state === 1) { td.className = "state-no"; td.innerText = "-"; }
                    else if(state === 2) { td.className = "state-yes"; td.innerText = "X"; }
                    else if(state === 3) { td.className = "state-maybe"; td.innerText = "?"; }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        };
        buildSection("SUSPECTS", appConfig.suspects, "s"); buildSection("ARMES", appConfig.weapons, "w"); buildSection("PIÈCES", appConfig.places, "p");
        updateMath();
    }

    function toggleCell(key, pIndex, typePrefix, itemIndex) {
        let current = gridData[key] || 0; let next = (current + 1) % 4; gridData[key] = next;
        if (next === 2) {
            let totalPlayers = appConfig.playerCount + 1;
            for(let i=0; i<totalPlayers; i++) { if(i !== pIndex) { let oKey = `p${i}_${typePrefix}${itemIndex}`; if((gridData[oKey] || 0) !== 2) gridData[oKey] = 1; } }
            renderTable();
        } else { renderTable(); }
        saveGameData(); renderCluesList();
    }

    function updateMath() {
        const checkRow = (type, list) => {
            let candidates = [];
            list.forEach((_, idx) => {
                let code = `${type}${idx}`;
                let row = document.getElementById(`row-${code}`);
                if(!row) return;

                let noCount = 0; let yesFound = false; let totalPlayers = appConfig.playerCount + 1;
                for(let p=0; p<totalPlayers; p++) {
                    let s = gridData[`p${p}_${code}`] || 0;
                    if(s === 1) noCount++; if(s === 2) yesFound = true;
                }

                row.className = ""; row.style.opacity = "1";
                if (yesFound) { row.style.opacity = "0.3"; row.classList.add("eliminated-row"); }
                else { candidates.push({idx: idx, confirmedNo: (noCount === totalPlayers)}); }
            });

            if (candidates.length === 1) {
                document.getElementById(`row-${type}${candidates[0].idx}`).classList.add("solution-found");
            } else {
                candidates.forEach(c => {
                    if(c.confirmedNo) document.getElementById(`row-${type}${c.idx}`).classList.add("solution-found");
                });
            }
        };
        checkRow("s", appConfig.suspects); checkRow("w", appConfig.weapons); checkRow("p", appConfig.places);
    }

    // --- SHERLOCK ---
    function updateSherlockUI() {
        const fill = (id, items, prefix) => { let sel = document.getElementById(id); sel.innerHTML = ""; items.forEach((item, idx) => { let opt = document.createElement("option"); opt.value = `${prefix}${idx}`; opt.innerText = item; sel.appendChild(opt); }); };
        let opponents = document.getElementById("s-player"); opponents.innerHTML = "";
        appConfig.playerNames.forEach((name, idx) => { let opt = document.createElement("option"); opt.value = idx + 1; opt.innerText = name; opponents.appendChild(opt); });
        fill("s-suspect", appConfig.suspects, "s"); fill("s-weapon", appConfig.weapons, "w"); fill("s-place", appConfig.places, "p");
        renderCluesList();
    }

    function addClue() {
        let pIdx = parseInt(document.getElementById("s-player").value);
        clues.push({ pIdx: pIdx, cards: [document.getElementById("s-suspect").value, document.getElementById("s-weapon").value, document.getElementById("s-place").value], id: Date.now() });
        saveGameData(); renderCluesList();
    }

    function renderCluesList() {
        const list = document.getElementById("clueList"); list.innerHTML = "";
        clues.slice().reverse().forEach(clue => {
            let pName = appConfig.playerNames[clue.pIdx - 1] || `Inconnu`;
            const getName = (code) => { let idx = parseInt(code.substring(1)); if(code[0]==='s') return appConfig.suspects[idx]; if(code[0]==='w') return appConfig.weapons[idx]; return appConfig.places[idx]; };
            
            let statuses = clue.cards.map(code => gridData[`p${clue.pIdx}_${code}`] || 0);
            
            // LOGIQUE CORRIGÉE : On ne déduit que si 2 cartes sont éliminées (== 1)
            let eliminatedCount = statuses.filter(s => s === 1).length;
            let foundIndex = -1;
            
            if(eliminatedCount === 2) {
                // S'il ne reste qu'une seule carte possible (qu'elle soit Vide, ? ou Oui), c'est elle.
                foundIndex = statuses.findIndex(s => s !== 1);
            }

            let div = document.createElement("div"); div.className = "clue-card" + (foundIndex !== -1 ? " solved" : "");
            let html = `<div><strong>${pName}</strong> a montré :</div><div class="clue-items">`;
            
            clue.cards.forEach((code, i) => { 
                let cls = "clue-tag"; 
                if(statuses[i]===1) cls+=" eliminated"; 
                if(i===foundIndex) cls+=" found"; 
                else if(statuses[i]===2) cls+=" maybe-yes"; // Petit indicateur si on sait qu'il l'a
                html += `<span class="${cls}">${getName(code)}</span>`; 
            });
            
            html += `</div><button class="del-clue" onclick="delClue(${clue.id})">×</button>`;
            if(foundIndex !== -1) html += `<div style="margin-top:5px; color:var(--secondary); font-weight:bold;">DÉDUCTION : ${getName(clue.cards[foundIndex])} !</div>`;
            div.innerHTML = html; list.appendChild(div);
        });
    }

    function delClue(id) { clues = clues.filter(c => c.id !== id); saveGameData(); renderCluesList(); }

    // --- STORAGE ---
    function loadData() {
        let c = localStorage.getItem("cluedo_config_v6"); if (c) appConfig = JSON.parse(c); else appConfig = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        let g = localStorage.getItem("cluedo_grid_v6"); if (g) gridData = JSON.parse(g);
        let cl = localStorage.getItem("cluedo_clues_v6"); if (cl) clues = JSON.parse(cl);
    }
    function saveGameData() { localStorage.setItem("cluedo_grid_v6", JSON.stringify(gridData)); localStorage.setItem("cluedo_clues_v6", JSON.stringify(clues)); }
    function fullReset() { if(confirm("Tout effacer ?")) { localStorage.removeItem("cluedo_config_v6"); localStorage.removeItem("cluedo_grid_v6"); localStorage.removeItem("cluedo_clues_v6"); location.reload(); } }
    function switchTab(t) { document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.querySelectorAll('nav button').forEach(e=>e.classList.remove('active')); document.getElementById(`page-${t}`).classList.add('active'); document.getElementById(`btn-${t}`).classList.add('active'); }

    init();
</script>
</body>
</html>
